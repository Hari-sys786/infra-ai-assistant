<div class="chat-wrapper">
  <!-- Top Bar -->
  <div class="chat-topbar">
    <div class="topbar-left">
      <h1 class="topbar-title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
        </svg>
        Infra AI Assistant
      </h1>
    </div>

    <div class="mode-selector">
      <button
        *ngFor="let mode of modes"
        class="mode-btn"
        [class.active]="agentMode === mode.value"
        (click)="setMode(mode.value)"
      >
        <span class="mode-icon">{{ mode.icon }}</span>
        <span class="mode-label">{{ mode.label }}</span>
      </button>
    </div>

    <div class="topbar-actions">
      <button class="action-btn clear-btn" (click)="clearChat()" title="Clear chat">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Agent Options (Config) -->
  <div class="agent-options" *ngIf="agentMode === 'config'">
    <div class="option-group">
      <label>Vendor (optional)</label>
      <input
        type="text"
        [(ngModel)]="configVendor"
        placeholder="Juniper"
        class="option-input"
      />
    </div>
  </div>

  <!-- Messages -->
  <div class="messages-container" #messageContainer>
    <div class="messages-inner">
      <div
        *ngFor="let msg of messages; let i = index"
        class="message-row fade-in"
        [class.user-row]="msg.role === 'user'"
        [class.assistant-row]="msg.role === 'assistant'"
      >
        <!-- Avatar -->
        <div class="message-avatar" [class.user-avatar]="msg.role === 'user'" [class.assistant-avatar]="msg.role === 'assistant'">
          <svg *ngIf="msg.role === 'user'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          <svg *ngIf="msg.role === 'assistant'" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="10" rx="2"/>
            <circle cx="12" cy="5" r="2"/>
            <path d="M12 7v4"/>
            <line x1="8" y1="16" x2="8" y2="16"/>
            <line x1="16" y1="16" x2="16" y2="16"/>
          </svg>
        </div>

        <!-- Bubble -->
        <div class="message-bubble" [class.user-bubble]="msg.role === 'user'" [class.assistant-bubble]="msg.role === 'assistant'">
          <div class="message-content" [innerHTML]="formatContent(msg.content)"></div>

          <!-- Sources chips -->
          <div class="source-chips" *ngIf="msg.sources && msg.sources.length > 0">
            <button class="source-chip" (click)="showSourcePanel(msg.sources!)">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              {{ msg.sources!.length }} source{{ msg.sources!.length > 1 ? 's' : '' }}
            </button>
          </div>

          <div class="message-time" *ngIf="msg.timestamp">
            {{ msg.timestamp | date:'HH:mm' }}
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="message-row assistant-row fade-in" *ngIf="isLoading">
        <div class="message-avatar assistant-avatar">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="10" rx="2"/>
            <circle cx="12" cy="5" r="2"/>
            <path d="M12 7v4"/>
            <line x1="8" y1="16" x2="8" y2="16"/>
            <line x1="16" y1="16" x2="16" y2="16"/>
          </svg>
        </div>
        <div class="message-bubble assistant-bubble">
          <div class="typing-indicator">
            <span></span><span></span><span></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Area -->
  <div class="input-area">
    <div class="input-wrapper">
      <textarea
        #messageInput
        [(ngModel)]="inputText"
        (keydown)="onKeydown($event)"
        (input)="onTextareaInput($event)"
        placeholder="Ask about IT infrastructure..."
        rows="1"
        class="chat-input"
      ></textarea>
      <button
        class="send-btn"
        (click)="sendMessage()"
        [disabled]="isLoading || !inputText.trim()"
        [class.active]="inputText.trim() && !isLoading"
      >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="input-hint">Press Enter to send, Shift+Enter for new line</div>
  </div>

  <!-- Sources Panel -->
  <div class="sources-overlay" *ngIf="showSources" (click)="closeSources()"></div>
  <div class="sources-panel" [class.open]="showSources">
    <div class="sources-header">
      <h3>ðŸ“„ Sources</h3>
      <button class="close-btn" (click)="closeSources()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="sources-list">
      <div class="source-item" *ngFor="let source of selectedSources; let i = index">
        <div class="source-number">{{ i + 1 }}</div>
        <div class="source-info">
          <div class="source-vendor">{{ source.vendor }}</div>
          <div class="source-doc">{{ source.document }}</div>
          <div class="source-meta">
            <span *ngIf="source.page">Page {{ source.page }}</span>
            <span *ngIf="source.chunk !== null && source.chunk !== undefined">Chunk {{ source.chunk }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
