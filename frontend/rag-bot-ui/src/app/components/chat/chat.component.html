<div class="dashboard">
  <!-- ‚îÄ‚îÄ Top Bar ‚îÄ‚îÄ -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-mark">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2L2 7l10 5 10-5-10-5z" fill="url(#tg1)"/>
          <path d="M2 17l10 5 10-5" stroke="url(#tg2)" stroke-width="2" fill="none"/>
          <path d="M2 12l10 5 10-5" stroke="url(#tg2)" stroke-width="2" fill="none" opacity="0.5"/>
          <defs>
            <linearGradient id="tg1" x1="2" y1="2" x2="22" y2="12"><stop stop-color="#3B82F6"/><stop offset="1" stop-color="#8B5CF6"/></linearGradient>
            <linearGradient id="tg2" x1="2" y1="12" x2="22" y2="22"><stop stop-color="#3B82F6"/><stop offset="1" stop-color="#8B5CF6"/></linearGradient>
          </defs>
        </svg>
      </div>
      <div class="brand-info">
        <span class="brand-name">Infra AI Assistant</span>
        <span class="brand-tag">Enterprise IT Documentation Intelligence</span>
      </div>
    </div>

    <div class="stats">
      <div class="stat">
        <span class="stat-val">{{ totalChunks }}</span>
        <span class="stat-lbl">Chunks</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-val">{{ totalDocs }}</span>
        <span class="stat-lbl">Documents</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-val">{{ totalQueries }}</span>
        <span class="stat-lbl">Queries</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-val status-dot-wrap"><span class="status-dot"></span> {{ health?.status || '...' }}</span>
        <span class="stat-lbl">Status</span>
      </div>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ Main Area ‚îÄ‚îÄ -->
  <div class="main">
    <!-- ‚îÄ‚îÄ Chat Column ‚îÄ‚îÄ -->
    <div class="chat-col">
      <div class="chat-scroll" #messageContainer>
        <div class="chat-inner">
          <!-- Hero -->
          <div class="hero" *ngIf="messages.length === 0">
            <div class="hero-icon">‚ú¶</div>
            <h2 class="hero-title">What can I help you with?</h2>
            <p class="hero-sub">Ask questions about your indexed infrastructure docs ‚Äî networking, servers, firewalls, storage, and more.</p>
            <div class="hero-chips">
              <button class="chip" (click)="inputText = 'What is FortiGate and its key features?'; sendMessage()">üî• FortiGate overview</button>
              <button class="chip" (click)="inputText = 'How to configure VLANs on Cisco?'; sendMessage()">üîß VLAN configuration</button>
              <button class="chip" (click)="inputText = 'Dell PowerEdge server specs'; sendMessage()">üìä PowerEdge specs</button>
              <button class="chip" (click)="inputText = 'Firewall security best practices'; sendMessage()">üõ°Ô∏è Security best practices</button>
            </div>
          </div>

          <!-- Messages -->
          <ng-container *ngFor="let msg of messages">
            <div class="msg" [class.msg--user]="msg.role === 'user'" [class.msg--ai]="msg.role === 'assistant'">
              <!-- AI -->
              <div class="ai-block" *ngIf="msg.role === 'assistant'">
                <div class="ai-head">
                  <span class="ai-badge"><span class="star">‚ú¶</span> Assistant</span>
                  <span class="time">{{ msg.timestamp | date:'HH:mm' }}</span>
                </div>
                <div class="ai-text" [innerHTML]="formatContent(msg.content)"></div>
                <button class="src-btn" *ngIf="msg.sources && msg.sources.length" (click)="showSourcePanel(msg.sources!)">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                  {{ msg.sources!.length }} source{{ msg.sources!.length > 1 ? 's' : '' }}
                </button>
              </div>
              <!-- User -->
              <div class="user-bubble" *ngIf="msg.role === 'user'">
                {{ msg.content }}
                <span class="time-u">{{ msg.timestamp | date:'HH:mm' }}</span>
              </div>
            </div>
          </ng-container>

          <!-- Thinking -->
          <div class="msg msg--ai" *ngIf="isLoading">
            <div class="ai-block">
              <div class="ai-head"><span class="ai-badge"><span class="star">‚ú¶</span> Assistant</span></div>
              <div class="thinking"><span class="d"></span><span class="d"></span><span class="d"></span><em>Searching documentation‚Ä¶</em></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Panel (slides up above input) -->
      <div class="upload-panel" *ngIf="showUpload">
        <div class="up-header">
          <h4>Upload Document</h4>
          <button class="x-btn" (click)="toggleUpload()">‚úï</button>
        </div>
        <div class="up-body">
          <input type="text" [(ngModel)]="uploadVendor" placeholder="Vendor (e.g. Cisco, Dell)" class="up-input" />
          <div class="drop-zone" [class.dragging]="isDragging" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)" (click)="fileInput.click()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            <span>Drop PDF or HTML here, or <u>browse</u></span>
            <input #fileInput type="file" accept=".pdf,.html,.htm" (change)="onFileSelected($event)" hidden />
          </div>
          <div class="up-progress" *ngIf="isUploading"><div class="bar"><div class="fill"></div></div></div>
          <p class="up-msg" *ngIf="uploadMsg" [class.ok]="uploadOk" [class.err]="!uploadOk && !isUploading">{{ uploadMsg }}</p>
        </div>
        <!-- Indexed docs mini table -->
        <div class="up-docs" *ngIf="documents.length > 0">
          <h5>Indexed Documents <span class="doc-count">{{ totalChunks }} chunks</span></h5>
          <div class="doc-list">
            <div class="doc-row" *ngFor="let doc of documents">
              <span class="doc-vendor">{{ doc.vendor }}</span>
              <span class="doc-name">{{ doc.document }}</span>
              <span class="doc-chunks">{{ doc.chunk_count }}</span>
              <button class="doc-del" (click)="deleteDocument(doc)" title="Remove">‚úï</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Bar -->
      <div class="input-bar">
        <div class="input-row">
          <button class="attach-btn" (click)="toggleUpload()" [class.active]="showUpload" title="Upload documents">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
            </svg>
          </button>
          <textarea #messageInput [(ngModel)]="inputText" (keydown)="onKeydown($event)" (input)="onTextareaInput($event)" placeholder="Ask about your infrastructure docs..." rows="1" class="the-input"></textarea>
          <button class="send-btn" (click)="sendMessage()" [disabled]="isLoading || !inputText.trim()" [class.ready]="inputText.trim() && !isLoading">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
        <div class="input-foot">
          <button class="foot-btn" (click)="clearChat()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
            New chat
          </button>
          <span class="foot-hint">Hybrid RAG ¬∑ Multi-turn ¬∑ Enter to send</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Sources Drawer ‚îÄ‚îÄ -->
  <div class="overlay" *ngIf="showSources" (click)="closeSources()"></div>
  <aside class="drawer" [class.open]="showSources">
    <div class="drawer-head">
      <h3>üìÑ References</h3>
      <button class="x-btn" (click)="closeSources()">‚úï</button>
    </div>
    <div class="drawer-body">
      <div class="ref" *ngFor="let s of selectedSources; let i = index">
        <span class="ref-n">{{ i + 1 }}</span>
        <div class="ref-info">
          <span class="ref-v">{{ s.vendor }}</span>
          <span class="ref-d">{{ s.document }}</span>
          <span class="ref-m"><span *ngIf="s.page">Page {{ s.page }}</span> <span *ngIf="s.chunk !== null && s.chunk !== undefined">¬∑ Chunk {{ s.chunk }}</span></span>
        </div>
      </div>
    </div>
  </aside>
</div>
