<div class="dashboard">
  <!-- Hidden file input -->
  <input #fileInput type="file" accept=".pdf,.html,.htm" multiple (change)="onFileSelected($event)" hidden />

  <!-- â”€â”€ Top Bar â”€â”€ -->
  <header class="topbar">
    <div class="brand">
      <div class="brand-mark">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M12 2L2 7l10 5 10-5-10-5z" fill="url(#tg1)"/>
          <path d="M2 17l10 5 10-5" stroke="url(#tg2)" stroke-width="2" fill="none"/>
          <path d="M2 12l10 5 10-5" stroke="url(#tg2)" stroke-width="2" fill="none" opacity="0.5"/>
          <defs>
            <linearGradient id="tg1" x1="2" y1="2" x2="22" y2="12"><stop stop-color="#3B82F6"/><stop offset="1" stop-color="#8B5CF6"/></linearGradient>
            <linearGradient id="tg2" x1="2" y1="12" x2="22" y2="22"><stop stop-color="#3B82F6"/><stop offset="1" stop-color="#8B5CF6"/></linearGradient>
          </defs>
        </svg>
      </div>
      <div class="brand-info">
        <span class="brand-name">Infra AI Assistant</span>
        <span class="brand-tag">Enterprise IT Documentation Intelligence</span>
      </div>
    </div>

    <div class="topbar-right">
      <div class="stats">
        <div class="stat">
          <span class="stat-val">{{ totalChunks }}</span>
          <span class="stat-lbl">Chunks</span>
        </div>
        <div class="stat-divider"></div>
        <div class="stat">
          <span class="stat-val">{{ totalDocs }}</span>
          <span class="stat-lbl">Docs</span>
        </div>
        <div class="stat-divider"></div>
        <div class="stat">
          <span class="stat-val">{{ totalQueries }}</span>
          <span class="stat-lbl">Queries</span>
        </div>
        <div class="stat-divider"></div>
        <div class="stat">
          <span class="stat-val status-dot-wrap"><span class="status-dot"></span></span>
          <span class="stat-lbl">{{ health?.status || '...' }}</span>
        </div>
      </div>
      <!-- Docs button in topbar -->
      <button class="docs-btn" (click)="toggleDocs()" [class.active]="showDocs" title="View indexed documents">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
        <span class="docs-btn-count" *ngIf="totalDocs > 0">{{ totalDocs }}</span>
      </button>
    </div>
  </header>

  <!-- â”€â”€ Upload Toast (floats above chat) â”€â”€ -->
  <div class="upload-toast" *ngIf="uploads.length > 0">
    <div class="ut-item" *ngFor="let u of uploads; let i = index" [class.done]="u.status === 'done'" [class.err]="u.status === 'error'">
      <div class="ut-icon">
        <svg *ngIf="u.status === 'done'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        <svg *ngIf="u.status === 'error'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        <div *ngIf="u.status === 'uploading'" class="ut-spinner"></div>
      </div>
      <div class="ut-info">
        <span class="ut-name">{{ u.name }}</span>
        <span class="ut-meta">{{ u.size }} Â· {{ u.msg }}</span>
      </div>
      <button class="ut-x" (click)="removeUploadItem(i)">âœ•</button>
    </div>
  </div>

  <!-- â”€â”€ Main Chat â”€â”€ -->
  <div class="chat-col">
    <div class="chat-scroll" #messageContainer>
      <div class="chat-inner">
        <!-- Hero -->
        <div class="hero" *ngIf="messages.length === 0">
          <div class="hero-icon">âœ¦</div>
          <h2 class="hero-title">What can I help you with?</h2>
          <p class="hero-sub">Ask questions about your indexed infrastructure docs â€” networking, servers, firewalls, storage, and more.</p>
          <div class="hero-chips">
            <button class="chip" (click)="inputText = 'What is FortiGate and its key features?'; sendMessage()">ğŸ”¥ FortiGate overview</button>
            <button class="chip" (click)="inputText = 'How to configure VLANs on Cisco?'; sendMessage()">ğŸ”§ VLAN configuration</button>
            <button class="chip" (click)="inputText = 'Dell PowerEdge server specs'; sendMessage()">ğŸ“Š PowerEdge specs</button>
            <button class="chip" (click)="inputText = 'Firewall security best practices'; sendMessage()">ğŸ›¡ï¸ Security best practices</button>
          </div>
        </div>

        <!-- Messages -->
        <ng-container *ngFor="let msg of messages">
          <div class="msg" [class.msg--user]="msg.role === 'user'" [class.msg--ai]="msg.role === 'assistant'">
            <div class="ai-block" *ngIf="msg.role === 'assistant'">
              <div class="ai-head">
                <span class="ai-badge"><span class="star">âœ¦</span> Assistant</span>
                <span class="time">{{ msg.timestamp | date:'HH:mm' }}</span>
              </div>
              <div class="ai-text" [innerHTML]="formatContent(msg.content)"></div>
              <button class="src-btn" *ngIf="msg.sources && msg.sources.length" (click)="showSourcePanel(msg.sources!)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                {{ msg.sources!.length }} source{{ msg.sources!.length > 1 ? 's' : '' }}
              </button>
            </div>
            <div class="user-bubble" *ngIf="msg.role === 'user'">
              {{ msg.content }}
              <span class="time-u">{{ msg.timestamp | date:'HH:mm' }}</span>
            </div>
          </div>
        </ng-container>

        <!-- Thinking -->
        <div class="msg msg--ai" *ngIf="isLoading">
          <div class="ai-block">
            <div class="ai-head"><span class="ai-badge"><span class="star">âœ¦</span> Assistant</span></div>
            <div class="thinking"><span class="d"></span><span class="d"></span><span class="d"></span><em>Searching documentationâ€¦</em></div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€ Input Bar â”€â”€ -->
    <div class="input-bar">
      <div class="input-row">
        <button class="attach-btn" (click)="openFilePicker()" title="Upload PDF or HTML">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
          </svg>
        </button>
        <textarea #messageInput [(ngModel)]="inputText" (keydown)="onKeydown($event)" (input)="onTextareaInput($event)" placeholder="Ask about your infrastructure docs..." rows="1" class="the-input"></textarea>
        <button class="send-btn" (click)="sendMessage()" [disabled]="isLoading || !inputText.trim()" [class.ready]="inputText.trim() && !isLoading">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </button>
      </div>
      <div class="input-foot">
        <button class="foot-btn" (click)="clearChat()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
          New chat
        </button>
        <span class="foot-hint">Hybrid RAG Â· Multi-turn Â· Enter to send</span>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Docs Drawer (right side) â”€â”€ -->
  <div class="overlay" *ngIf="showDocs" (click)="toggleDocs()"></div>
  <aside class="drawer" [class.open]="showDocs">
    <div class="drawer-head">
      <h3>ğŸ“š Indexed Documents</h3>
      <button class="x-btn" (click)="toggleDocs()">âœ•</button>
    </div>
    <div class="drawer-summary">
      <div class="ds-stat"><span class="ds-val">{{ totalDocs }}</span> documents</div>
      <div class="ds-stat"><span class="ds-val">{{ totalChunks }}</span> chunks</div>
    </div>
    <div class="drawer-body">
      <div class="doc-card" *ngFor="let doc of documents">
        <div class="dc-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        </div>
        <div class="dc-info">
          <span class="dc-name">{{ doc.document }}</span>
          <div class="dc-meta">
            <span class="dc-badge">{{ doc.vendor }}</span>
            <span>{{ doc.chunk_count }} chunks</span>
            <span *ngIf="doc.page_count">Â· {{ doc.page_count }} pages</span>
          </div>
        </div>
        <button class="dc-del" (click)="deleteDocument(doc)" title="Remove from index">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
        </button>
      </div>
      <div class="drawer-empty" *ngIf="documents.length === 0">
        <p>No documents indexed yet</p>
        <span>Click the ğŸ“ in the chat input to upload files</span>
      </div>
    </div>
  </aside>

  <!-- â”€â”€ Sources Drawer â”€â”€ -->
  <div class="overlay" *ngIf="showSources" (click)="closeSources()"></div>
  <aside class="drawer" [class.open]="showSources">
    <div class="drawer-head">
      <h3>ğŸ“„ References</h3>
      <button class="x-btn" (click)="closeSources()">âœ•</button>
    </div>
    <div class="drawer-body">
      <div class="ref" *ngFor="let s of selectedSources; let i = index">
        <span class="ref-n">{{ i + 1 }}</span>
        <div class="ref-info">
          <span class="ref-v">{{ s.vendor }}</span>
          <span class="ref-d">{{ s.document }}</span>
          <span class="ref-m"><span *ngIf="s.page">Page {{ s.page }}</span> <span *ngIf="s.chunk !== null && s.chunk !== undefined">Â· Chunk {{ s.chunk }}</span></span>
        </div>
      </div>
    </div>
  </aside>
</div>
