<div class="chat-wrapper">
  <!-- Messages -->
  <div class="messages-area" #messageContainer>
    <div class="messages-inner">
      <!-- Hero Empty State -->
      <div class="hero" *ngIf="messages.length <= 1 && !isLoading">
        <div class="hero-logo">
          <svg width="44" height="44" viewBox="0 0 24 24" fill="none">
            <path d="M12 2L2 7l10 5 10-5-10-5z" fill="url(#g1)"/>
            <path d="M2 17l10 5 10-5" stroke="url(#g2)" stroke-width="2" fill="none"/>
            <path d="M2 12l10 5 10-5" stroke="url(#g2)" stroke-width="2" fill="none" opacity="0.5"/>
            <defs>
              <linearGradient id="g1" x1="2" y1="2" x2="22" y2="12">
                <stop stop-color="#3B82F6"/><stop offset="1" stop-color="#8B5CF6"/>
              </linearGradient>
              <linearGradient id="g2" x1="2" y1="12" x2="22" y2="22">
                <stop stop-color="#3B82F6"/><stop offset="1" stop-color="#8B5CF6"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <h1 class="hero-title">Infra AI Assistant</h1>
        <p class="hero-desc">Ask anything about your IT infrastructure documentation.<br>Powered by hybrid RAG search with multi-turn conversations.</p>

        <div class="suggestions">
          <button class="chip" (click)="inputText = 'What is FortiGate and its key features?'; sendMessage()">
            <span class="chip-icon">ğŸ”¥</span> What is FortiGate?
          </button>
          <button class="chip" (click)="inputText = 'How to configure VLANs on a Cisco switch?'; sendMessage()">
            <span class="chip-icon">ğŸ”§</span> Configure VLANs
          </button>
          <button class="chip" (click)="inputText = 'Dell PowerEdge server specifications'; sendMessage()">
            <span class="chip-icon">ğŸ“Š</span> PowerEdge specs
          </button>
          <button class="chip" (click)="inputText = 'Firewall security best practices'; sendMessage()">
            <span class="chip-icon">ğŸ›¡ï¸</span> Firewall best practices
          </button>
        </div>
      </div>

      <!-- Messages -->
      <ng-container *ngFor="let msg of messages; let i = index">
        <div
          class="msg"
          [class.msg--user]="msg.role === 'user'"
          [class.msg--ai]="msg.role === 'assistant'"
          [class.fade-up]="true"
        >
          <!-- AI messages: full width block -->
          <div class="msg-inner" *ngIf="msg.role === 'assistant'">
            <div class="msg-head">
              <div class="ai-badge">
                <span class="ai-star">âœ¦</span> Assistant
              </div>
              <span class="msg-time" *ngIf="msg.timestamp">{{ msg.timestamp | date:'HH:mm' }}</span>
            </div>
            <div class="msg-text" [innerHTML]="formatContent(msg.content)"></div>
            <div class="msg-actions" *ngIf="msg.sources && msg.sources.length > 0">
              <button class="src-btn" (click)="showSourcePanel(msg.sources!)">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/>
                </svg>
                {{ msg.sources!.length }} source{{ msg.sources!.length > 1 ? 's' : '' }} cited
              </button>
            </div>
          </div>

          <!-- User messages: right-aligned bubble -->
          <div class="user-bubble" *ngIf="msg.role === 'user'">
            <div class="bubble-text">{{ msg.content }}</div>
            <span class="msg-time" *ngIf="msg.timestamp">{{ msg.timestamp | date:'HH:mm' }}</span>
          </div>
        </div>
      </ng-container>

      <!-- Thinking -->
      <div class="msg msg--ai fade-up" *ngIf="isLoading">
        <div class="msg-inner">
          <div class="msg-head">
            <div class="ai-badge"><span class="ai-star">âœ¦</span> Assistant</div>
          </div>
          <div class="thinking">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            <span class="thinking-label">Searching docs &amp; generating answerâ€¦</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Input Bar -->
  <div class="input-bar">
    <div class="input-row">
      <textarea
        #messageInput
        [(ngModel)]="inputText"
        (keydown)="onKeydown($event)"
        (input)="onTextareaInput($event)"
        placeholder="Ask about your infrastructure..."
        rows="1"
        class="the-input"
      ></textarea>
      <button class="btn-send" (click)="sendMessage()" [disabled]="isLoading || !inputText.trim()" [class.active]="inputText.trim() && !isLoading">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </div>
    <div class="input-meta">
      <button class="meta-btn" (click)="clearChat()" title="New chat">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/>
        </svg>
        New chat
      </button>
      <span class="meta-text">Enter to send Â· Shift+Enter for new line</span>
    </div>
  </div>

  <!-- Sources Drawer -->
  <div class="overlay" *ngIf="showSources" (click)="closeSources()"></div>
  <aside class="drawer" [class.open]="showSources">
    <div class="drawer-top">
      <h3>ğŸ“„ Sources</h3>
      <button class="icon-btn" (click)="closeSources()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="drawer-list">
      <div class="ref" *ngFor="let s of selectedSources; let i = index">
        <div class="ref-num">{{ i + 1 }}</div>
        <div class="ref-body">
          <div class="ref-vendor">{{ s.vendor }}</div>
          <div class="ref-doc">{{ s.document }}</div>
          <div class="ref-meta">
            <span *ngIf="s.page">Page {{ s.page }}</span>
            <span *ngIf="s.chunk !== null && s.chunk !== undefined">Â· Chunk {{ s.chunk }}</span>
          </div>
        </div>
      </div>
    </div>
  </aside>
</div>
